name: Extract Command Schemas

on:
  workflow_dispatch:
    # Allow manual triggering
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  push:
    branches:
      - main
    paths:
      - 'ci-config.yaml'
      - '.github/workflows/extract-schemas.yml'

permissions:
  contents: write

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install comprehensive toolset
        run: |
          # Update package lists
          sudo apt-get update

          # Coreutils (most already installed on Ubuntu)
          sudo apt-get install -y coreutils findutils grep sed gawk

          # Development tools
          sudo apt-get install -y \
            git gh docker.io docker-compose \
            build-essential cmake gcc g++ clang \
            python3 python3-pip \
            nodejs npm \
            ruby ruby-dev \
            openjdk-17-jdk maven gradle \
            php composer \
            perl lua5.4

          # Install Rust tools
          rustup component add rustfmt clippy

          # Install additional package managers
          npm install -g yarn pnpm

          # Install kubectl and helm
          KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl.sha256"
          echo "$(cat kubectl.sha256)  kubectl" | sha256sum -c -
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          rm -f kubectl kubectl.sha256
          HELM_VERSION=$(curl -fsSL https://api.github.com/repos/helm/helm/releases/latest | jq -r '.tag_name')
          curl -fsSL -o helm.tar.gz "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz"
          curl -fsSL -o helm.tar.gz.sha256sum "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz.sha256sum"
          sha256sum -c helm.tar.gz.sha256sum
          tar -xzf helm.tar.gz
          sudo install -o root -g root -m 0755 linux-amd64/helm /usr/local/bin/helm
          rm -rf helm.tar.gz helm.tar.gz.sha256sum linux-amd64

          # Install modern CLI tools (pre-built for speed)
          sudo apt-get install -y ripgrep fd-find bat

          # Install jq and yq
          sudo apt-get install -y jq
          YQ_VERSION=$(curl -fsSL https://api.github.com/repos/mikefarah/yq/releases/latest | jq -r '.tag_name')
          curl -fsSL -o yq_linux_amd64 "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          curl -fsSL -o yq_checksums "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/checksums"
          expected_checksum=$(grep "yq_linux_amd64$" yq_checksums | awk '{print $1}')
          echo "${expected_checksum}  yq_linux_amd64" | sha256sum -c -
          sudo install -o root -g root -m 0755 yq_linux_amd64 /usr/local/bin/yq
          rm -f yq_linux_amd64 yq_checksums

          # System utilities (most already installed)
          sudo apt-get install -y \
            systemd net-tools iproute2 iputils-ping \
            curl wget openssh-client rsync \
            htop lsof strace

          # Text editors
          sudo apt-get install -y vim nano

          # Compression tools
          sudo apt-get install -y \
            gzip bzip2 xz-utils zip unzip p7zip-full

          # Additional utilities
          sudo apt-get install -y tmux screen file binutils

      - name: Build schema-discover CLI
        run: |
          cargo build --release -p command-schema-cli
          sudo cp target/release/schema-discover /usr/local/bin/

      - name: Run CI extraction
        run: |
          schema-discover ci-extract \
            --config ci-config.yaml \
            --manifest schemas/database/manifest.json \
            --output schemas/database/

      - name: Generate summary
        id: summary
        run: |
          # Count extracted schemas
          SCHEMA_COUNT=$(find schemas/database/ -name "*.json" -not -name "manifest.json" | wc -l)
          echo "schema_count=$SCHEMA_COUNT" >> $GITHUB_OUTPUT

          # Count changed schemas (both tracked modifications and untracked new files)
          if [ -f schemas/database/manifest.json ]; then
            CHANGED=$(git status --porcelain -- 'schemas/database/' | awk '{print $2}' | grep -v manifest.json | grep '\.json$' | wc -l)
            echo "changed_count=$CHANGED" >> $GITHUB_OUTPUT
          else
            echo "changed_count=$SCHEMA_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add schemas/database/
          git add ci-config.yaml .github/workflows/extract-schemas.yml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SCHEMA_COUNT="${{ steps.summary.outputs.schema_count }}"
            CHANGED_COUNT="${{ steps.summary.outputs.changed_count }}"

            git commit -m "Update command schemas: $CHANGED_COUNT changed, $SCHEMA_COUNT total"
            git push
          fi

      - name: Upload extraction report
        if: always() && hashFiles('schemas/database/extraction-report.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: extraction-report
          path: schemas/database/extraction-report.json
          if-no-files-found: ignore
          retention-days: 30
